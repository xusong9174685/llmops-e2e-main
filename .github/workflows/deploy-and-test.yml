name: Deploy and Test on kind

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Trivy Remote Scan"]
    types: [completed]

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Start kind cluster
        run: kind create cluster --name github-ci

      - name: Export kubeconfig
        run: kind get kubeconfig --name github-ci > $KUBECONFIG

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest

      - name: Verify cluster access
        run: kubectl get nodes

      - name: Load Docker image into kind
        run: |
          docker pull xusonglin/fastapi-app:latest
          kind load docker-image xusonglin/fastapi-app:latest --name github-ci

      - name: Deploy app
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

      - name: Wait for pod readiness
        run: kubectl wait --for=condition=ready pod -l app=gpt-hf-pod --timeout=600s

      - name: Debug services and pods
        run: |
          echo "--- Pods ---"
          kubectl get pods -o wide
          echo "--- Services ---"
          kubectl get svc -o wide
          echo "--- Describe Service ---"
          kubectl describe svc gpt-hf-service || true
          echo "--- Describe Pods ---"
          kubectl describe pods -l app=gpt-hf-pod || true

      - name: Test API inside cluster
        run: |
          kubectl run tester --rm -i --restart=Never \
            --image=curlimages/curl \
            --command -- \
            curl -s -X POST http://gpt-hf-service:8000/chat \
              -H "Content-Type: application/json" \
              -d "{\"question\": \"What does Hugging Face provides?\", \"context\": \"Hugging Face is a technology company that provides open-source NLP libraries ...\"}"

      - name: Install kube-score
        run: |
          curl -sLo kube-score.tar.gz https://github.com/zegl/kube-score/releases/download/v1.25.1/kube-score_1.25.1_linux_amd64.tar.gz
          tar -xzf kube-score.tar.gz kube-score
          sudo mv kube-score /usr/local/bin/

      - name: Run kube-score
        run: kube-score score --output-format ci deployment.yaml

      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name github-ci