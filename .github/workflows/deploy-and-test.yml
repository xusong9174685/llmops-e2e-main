name: Deploy and Test on kind

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Trivy Remote Scan"]
    types: [completed]

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install kind
      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      # 3. Start kind cluster
      - name: Start kind cluster
        run: kind create cluster --name github-ci

      # 4. Export kubeconfig
      - name: Export kubeconfig
        run: kind get kubeconfig --name github-ci > $KUBECONFIG

      # 5. Install kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest

      # 6. Wait for node to be ready (increase timeout)
      - name: Wait for node to be ready
        run: |
          echo "Waiting for control-plane node to be Ready..."
          kubectl wait --for=condition=Ready node/github-ci-control-plane --timeout=240s

      # 7. Load Docker image into kind
      - name: Load Docker image into kind
        run: |
          docker pull xusonglin/fastapi-app:latest
          kind load docker-image xusonglin/fastapi-app:latest --name github-ci

          # Verify image exists in kind node
          echo "Checking if image is available in kind node..."
          for i in $(seq 1 10); do
            if docker exec github-ci-control-plane crictl images | grep -q xusonglin/fastapi-app; then
              echo "Image is now available in kind node."
              break
            else
              echo "Waiting for image to load into kind node..."
              sleep 2
            fi
          done

      # 8. Deploy app
      - name: Deploy app
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

      # 9. Wait for pod to move out of ContainerCreating
      - name: Wait for pod to be scheduled
        run: |
          echo "Waiting for pod to start..."
          for i in {1..60}; do
            POD_STATUS=$(kubectl get pod -l app=gpt-hf-pod -o jsonpath='{.items[0].status.phase}')
            echo "Pod status: $POD_STATUS"
            if [[ "$POD_STATUS" == "Running" ]]; then
              break
            fi
            sleep 5
          done

      # 10. Wait for pod readiness (checks readiness probe)
      - name: Wait for pod readiness
        run: kubectl wait --for=condition=ready pod -l app=gpt-hf-pod --timeout=600s

      # 11. Debug services and pods
      - name: Show pods and services
        run: |
          echo "--- Pods ---"
          kubectl get pods -l app=gpt-hf-pod -o wide
          echo "--- Services ---"
          kubectl get svc gpt-hf-service -o wide
          echo "--- Describe Service ---"
          kubectl describe svc gpt-hf-service || true
          echo "--- Describe Pods ---"
          kubectl describe pods -l app=gpt-hf-pod || true

      # 12. Test API inside cluster with retry loop (pretty-printed JSON)
      - name: Test API inside cluster
        run: |
          # Create the pod
          kubectl run tester --restart=Never \
            --image=curlimages/curl -- /bin/sh -c '
              for i in $(seq 1 60); do
                RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/response.json -X POST http://gpt-hf-service:8000/chat \
                  -H "Content-Type: application/json" \
                  -d "{\"question\":\"What does Hugging Face provide?\", \"context\":\"Hugging Face is a technology company that provides open-source NLP libraries ...\"}")
                if [ "$RESPONSE" = "200" ]; then
                  echo "Service is responsive! Response:"
                  cat /tmp/response.json
                  exit 0
                else
                  echo "Waiting for /chat endpoint (attempt $i)... HTTP $RESPONSE"
                  sleep 5
                fi
              done

              echo "Timed out."
              exit 1
            '

          # Allow pod to write logs
          sleep 2

          echo "===== POD LOGS ====="
          kubectl logs tester || true

          kubectl delete pod tester --force --grace-period=0 || true

      # 13. Install kube-score
      - name: Install kube-score
        run: |
          curl -sSL --fail -o kube-score.tar.gz \
            https://github.com/zegl/kube-score/releases/download/v1.25.1/kube-score_1.25.1_linux_amd64.tar.gz
          file kube-score.tar.gz
          tar -xzf kube-score.tar.gz
          sudo mv kube-score /usr/local/bin/
          kube-score version

      # 14. Run kube-score
      - name: Run kube-score
        run: kube-score score --output-format ci deployment.yaml

      # 15. Delete kind cluster
      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name github-ci